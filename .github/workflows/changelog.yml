name: "Generate Changelog"

on:
  workflow_call:
    inputs:
      deployment_name:
        description: 'Name of the deployment (for release title)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: read

jobs:
  generate_changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22.19.0'

      - name: Generate changelog and create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOYMENT_NAME: ${{ inputs.deployment_name }}
        run: |
          echo "üöÄ Generating changelog for deployment: $DEPLOYMENT_NAME"
          echo "$GITHUB_TOKEN" | gh auth login --with-token
          node scripts/collect-prs.cjs

      - name: Notify about changelog generation
        if: success()
        run: |
          echo "‚úÖ Changelog generated successfully"
          echo "üîñ New GitHub release created"

      - name: Handle changelog generation failure
        if: failure()
        run: |
          echo "‚ùå Failed to generate changelog"
          echo "This might happen if:"
          echo "  - No PRs found since last release"
          echo "  - GitHub CLI authentication issues"
          echo "  - Repository access permissions"
          exit 1
