name: "Generate Changelog"

on:
  workflow_call:
    inputs:
      deployment_name:
        description: 'Name of the deployment (for release title)'
        required: true
        type: string
    secrets:
      GITHUB_TOKEN:
        required: true

permissions:
  contents: write
  pull-requests: read

jobs:
  generate_changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for changelog generation

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22.19.0'

      - name: Make script executable
        run: chmod +x scripts/collect-prs.js

      - name: Generate changelog and create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOYMENT_NAME: ${{ inputs.deployment_name }}
        run: |
          echo "üöÄ Generating changelog for deployment: $DEPLOYMENT_NAME"

          # Install GitHub CLI if not available
          if ! command -v gh &> /dev/null; then
            echo "üì• Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          fi

          # Authenticate GitHub CLI
          echo "$GITHUB_TOKEN" | gh auth login --with-token

          # Run the changelog script
          node scripts/collect-prs.js

      - name: Notify about changelog generation
        if: success()
        run: |
          echo "‚úÖ Changelog generated successfully"
          echo "üîñ New GitHub release created"

      - name: Handle changelog generation failure
        if: failure()
        run: |
          echo "‚ùå Failed to generate changelog"
          echo "This might happen if:"
          echo "  - No PRs found since last release"
          echo "  - GitHub CLI authentication issues"
          echo "  - Repository access permissions"
          exit 1